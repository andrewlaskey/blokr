<!DOCTYPE html>
<html>
 <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>title</title>
  <link rel="stylesheet" href="stylesheets/app.css" type="text/css">
 </head>
 <body>
    <ul class="blocks" data-size="3">
        <li data-row="1" data-col="1" data-offset="0" class="red"></li>
        <li data-row="1" data-col="2" data-offset="0" class="blue"></li>
        <li data-row="1" data-col="3" data-offset="0" class="blue"></li>

        <li data-row="2" data-col="1" data-offset="0" class="blue"></li>
        <li data-row="2" data-col="2" data-offset="0" class="red"></li>
        <li data-row="2" data-col="3" data-offset="0" class="red"></li>

        <li data-row="3" data-col="1" data-offset="0" class="green"></li>
        <li data-row="3" data-col="2" data-offset="0" class="green"></li>
        <li data-row="3" data-col="3" data-offset="0" class="green"></li>
        <!-- top -->
        <li data-row="0" data-col="1" data-offset="0" class="green outside"></li>
        <li data-row="0" data-col="2" data-offset="0" class="green outside"></li>
        <li data-row="0" data-col="3" data-offset="0" class="green outside"></li>

        <!-- left -->
        <li data-row="1" data-col="0" data-offset="0" class="blue outside"></li>
        <li data-row="2" data-col="0" data-offset="0" class="red outside"></li>
        <li data-row="3" data-col="0" data-offset="0" class="green outside"></li>

        <!-- bottom -->
        <li data-row="4" data-col="1" data-offset="0" class="red outside"></li>
        <li data-row="4" data-col="2" data-offset="0" class="blue outside"></li>
        <li data-row="4" data-col="3" data-offset="0" class="blue"></li>

        <!--right -->
        <li data-row="1" data-col="4" data-offset="0" class="red outside"></li>
        <li data-row="2" data-col="4" data-offset="0" class="blue outside"></li>
        <li data-row="3" data-col="4" data-offset="0" class="green outside"></li>
    </ul>

  
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js" type="text/javascript"></script>
  <script src="js/jquery.hammer.min.js" type="text/javascript"></script>
  <script type="text/javascript">

    var gridSize = parseInt($('.blocks').attr('data-size'),10);
    var blockSize = $('.blocks li').width();
    var total_delta = 0;
    var last_delta = 0;

    function truncate(n) {
      return n | 0; // bitwise operators convert operands to 32-bit integers
    }

    function setRowOffset(row,percent) {
        $('.blocks').removeClass('animate');

        $('[data-row=' + row + ']').css("transform", "translate3d(" + percent + "px,0,0)");

    }

    function setColumnOffset(col,percent) {
        $('.blocks').removeClass('animate');

        $('[data-col=' + col + ']').css("transform", "translate3d(0," + percent + "px,0)");
    }

    function updateRow(row, dir) {
        var shift = 1;

        if (dir === 'dragleft') {
            shift = -1;
        }

        $('[data-row=' + row + ']').each( function() {
            var offset = 0;
            var col = parseInt($(this).attr('data-col'),10);
            if (col + shift < 0) {
                offset = gridSize + 1;
            } else if (col + shift > gridSize + 1) {
                offset = 0;
            } else {
                offset = col + shift;
            }
            $(this).attr('data-col', offset)
                    .css("transform", "translate3d(0,0,0)");

        });
    }

    function updateColumn(col,dir) {
        var shift = 1;

        if (dir === 'dragup') {
            shift = -1;
        }

        $('[data-col=' + col + ']').each( function() {
            var offset = 0;
            var row = parseInt($(this).attr('data-row'),10);
            if (row + shift < 0) {
                offset = gridSize + 1;
            } else if (row + shift > gridSize + 1) {
                offset = 0;
            } else {
                offset = row + shift;
            }
            $(this).attr('data-row', offset)
                    .css("transform", "translate3d(0,0,0)");

        });
    }

    function updateEnds() {
        $('.blocks').removeClass('animate');

        var data;

        //set bottom outside row
        $('[data-row=1]').each(function() {
            data = $(this).attr('class');
            var col = $(this).attr('data-col');

            $('[data-row=' + (gridSize + 1) + '][data-col=' + col + ']').removeClass().addClass(data).addClass('change');

            setTimeout(function() {
                $('[data-row=' + (gridSize + 1) + '][data-col=' + col + ']').removeClass('change');
            }, 0);

        });

        //set top outside row
        $('[data-row=' + gridSize + ']').each(function() {
            data = $(this).attr('class');
            var col = $(this).attr('data-col');

            $('[data-row=0][data-col=' + col + ']').removeClass().addClass(data).addClass('change');

            setTimeout(function() {
                $('[data-row=0][data-col=' + col + ']').removeClass('change');
            }, 0);

        });

        //set right outside row
        $('[data-col=1]').each(function() {
            data = $(this).attr('class');
            var row = $(this).attr('data-row');

            $('[data-row=' + row + '][data-col=' + (gridSize + 1) + ']').removeClass().addClass(data).addClass('change');

            setTimeout(function() {
                $('[data-row=' + row + '][data-col=' + (gridSize + 1) + ']').removeClass('change');
            }, 0);

        });

        //set left outside row
        $('[data-col=' + gridSize + ']').each(function() {
            data = $(this).attr('class');
            var row = $(this).attr('data-row');

            $('[data-row=' + row + '][data-col=0]').removeClass().addClass(data).addClass('change');

            setTimeout(function() {
                $('[data-row=' + row + '][data-col=0]').removeClass('change');
            }, 0);

        });
    }


    function handleHammer(ev) {
        //console.log(ev);
        ev.gesture.preventDefault();

        var drag_offset_x = ev.gesture.deltaX;
        var drag_offset_y = ev.gesture.deltaY;


        switch(ev.type) {
            case 'dragright':
            case 'dragleft':

                var currentRow = $(this).attr('data-row');
                if (Math.abs(drag_offset_x - last_delta) >= blockSize) {
                    updateRow(currentRow, ev.type);
                    updateEnds();
                    last_delta = truncate(drag_offset_x);
                }
                drag_offset_x = (drag_offset_x - last_delta);
                setRowOffset(currentRow,drag_offset_x);
                
                
                break;
            case 'dragup':
            case 'dragdown':
                var currentCol = $(this).attr('data-col');

                if (Math.abs(drag_offset_y - last_delta) >= blockSize) {
                    updateColumn(currentCol, ev.type);
                    updateEnds();
                    last_delta = truncate(drag_offset_y);
                }
                drag_offset_y = (drag_offset_y - last_delta);

                setColumnOffset(currentCol,drag_offset_y);

                break;
            case 'swipeup':
                updateColumn($(this).attr('data-col'),1);
                break;
            case 'swipedown':
                updateColumn($(this).attr('data-col'),-1);
                break;
            case 'release':
                last_delta = 0;
                $('.blocks').addClass('animate');
                $('.blocks li').css("transform", "translate3d(0,0,0)");
                break;


        }
    }

    function initBlocks() {
        $('.blocks li').each(function() {
            var offset_x = $(this).attr('data-off-x');
            var offset_y = $(this).attr('data-off-y');
            $(this).css("transform", "translate3d(" + offset_x + "%," + offset_y + "%,0)");
        });
    }

    $(document).ready(function() {
        //initBlocks();
        $(".blocks li").hammer({drag_lock_to_axis: true})
                        .on("release dragstart dragend dragup dragdown dragleft dragright swipeup swipedown swipeleft swiperight", handleHammer);
    });
  </script>
 </body>
</html>